<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>
      Weld: Tour around Weld 3
    </title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="A summary of CDI 2.0 features coated with Weld and sprinkled with code samples" name="description">
    <link href="/images/weld_icon_32x.ico" rel="shortcut icon" type="image/x-icon">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//static.jboss.org/css/tabzilla.css" media="screen" rel="stylesheet" type="text/css">
    <link href="https://weld.cdi-spec.org/stylesheets/styles.css" rel="stylesheet" type="text/css">
    <script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="//static.jboss.org/js/_jbossorg-tabzilla.js" type="text/javascript"></script>
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
    <link href="https://weld.cdi-spec.org/news.atom" rel="alternate" type="application/atom+xml">
    <link href="//cdn.jsdelivr.net/highlight.js/8.9.1/styles/hybrid.min.css" rel="stylesheet">
    <script src="//cdn.jsdelivr.net/highlight.js/8.9.1/highlight.min.js" type="text/javascript"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-2 col-sm-3">
          <div class="sidebar-nav">
            <div class="navbar navbar-default" role="navigation">
              <div class="navbar-header">
                <button ="button" class="navbar-toggle" data-target=".sidebar-navbar-collapse" data-toggle="collapse">
                  <span class="sr-only">
                    Toggle navigation
                  </span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a ="#" class="visible-xs navbar-brand">
                  <img alt="Weld Logo" src="/images/weld_logo_100x.png">
                </a>
              </div>
              <div class="collapse navbar-collapse sidebar-navbar-collapse">
                <ul class="nav navbar-nav">
                  <li>
                    <a href="/">
                      <i class="fa fa-home"></i>
                      &nbsp;Home
                    </a>
                  </li>
                  <li>
                    <a href="/download">
                      <i class="fa fa-download"></i>
                      &nbsp;Download
                    </a>
                  </li>
                  <li>
                    <a href="/news">
                      <i class="fa fa-newspaper-o"></i>
                      &nbsp;News
                    </a>
                  </li>
                  <li>
                    <a href="https://issues.jboss.org/projects/WELD?selectedItem=com.atlassian.jira.jira-projects-plugin:release-page" target="_blank">
                      <i class="fa fa-road"></i>
                      &nbsp;Road Map
                    </a>
                  </li>
                  <li>
                    <a href="/documentation">
                      <i class="fa fa-book"></i>
                      &nbsp;Docs &amp; FAQ
                    </a>
                  </li>
                  <li>
                    <a href="/news/tags/tips">
                      <i class="fa fa-lightbulb-o"></i>
                      &nbsp;Tips and Tricks
                    </a>
                  </li>
                  <li>
                    <a href="/community">
                      <i class="fa fa-group"></i>
                      &nbsp;Community
                    </a>
                  </li>
                  <li>
                    <a href="http://github.com/weld" target="_blank">
                      <i class="fa fa-github-alt"></i>
                      &nbsp;Source Code
                    </a>
                  </li>
                  <li>
                    <a href="https://issues.jboss.org/browse/WELD#selectedTab=com.atlassian.jira.plugin.system.project%3Asummary-panel" target="_blank">
                      <i class="fa fa-tasks"></i>
                      &nbsp;Bug Tracker
                    </a>
                  </li>
                  <li>
                    <a href="https://twitter.com/jbossweld" target="_blank">
                      <i class="fa fa-twitter"></i>
                      &nbsp;Follow @jbossweld
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-10 col-sm-9">
          <div class="row hidden-xs">
            <div class="dropup">
              <div id="ajbossproject">
                A JBoss Project
              </div>
              <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
              <script>
                window.addEventListener('load', function() {renderTabzilla("Weld", "weld", false )}, false);
              </script>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <a href="/">
                <img alt="Weld Logo" class="hidden-xs weld-home-logo" src="/images/weld_logo_450x.png">
              </a>
            </div>
            <div class="col-md-8">
              <img alt="CDI tagcloud" class="hidden-xs hidden-sm cdi-background" src="/images/CDIbackground.png">
            </div>
          </div>
          <div class="row content-wrapper">
            <div class="col-md-12">
              <div class="post">
                <h1>
                  Tour around Weld 3
                  <a href="http://weld.cdi-spec.org/news.atom" title="Subscribe to Weld news">
                    <i class="fa fa-rss"></i>
                  </a>
                </h1>
                <div class="news-date news-boxed">
                  2017-5-19
                  &nbsp;
                  <i class="fa fa-pencil"></i>
                  Matej Novotny
                </div>
                <p></p>
                <div class="content">
                  <div id="toc" class="toc">
                  <div id="toctitle" class="title">Contents</div>
                  <ul class="sectlevel1">
                  <li><a href="#_async_events_and_notification_options">Async Events and Notification Options</a></li>
                  <li><a href="#_configurators_api">Configurators API</a></li>
                  <li><a href="#_se_bootstrap_api">SE Bootstrap API</a></li>
                  <li><a href="#_on_demand_request_context_activation">On-demand Request Context Activation</a></li>
                  <li><a href="#_observer_method_ordering">Observer Method Ordering</a></li>
                  <li><a href="#_intercepting_produced_beans">Intercepting Produced Beans</a></li>
                  <li><a href="#_trimmed_bean_archives">Trimmed Bean Archives</a></li>
                  </ul>
                  </div>
                  <div class="paragraph">
                  <p>This post briefly describes all the main CDI 2.0 features and elaborates on Weld-specific features we added on top of that.
                  It is not intended as a deep-dive but rather to give you the overall idea of what is going on and what can the new release offer.
                  So, enough talk, let&#8217;s get the show on the road!</p>
                  </div>
                  <div class="sect1">
                  <h2 id="_async_events_and_notification_options">Async Events and Notification Options</h2>
                  <div class="sectionbody">
                  <div class="paragraph">
                  <p>Up until now, the only way to send events was to do so synchronously.
                  That meant stopping the work of your current thread to instead occupy it with observer resolution and subsequent notification of observer methods.
                  Once all that was done, the thread resumed it&#8217;s work.</p>
                  </div>
                  <div class="paragraph">
                  <p>With CDI 2.0 there are asynchronous events - a 'fire &amp; forget' way of handling things.
                  Here is how to fire such and event and how to observe it:</p>
                  </div>
                  <div class="paragraph">
                  <p>[ source, java ]</p>
                  </div>
                  <div class="listingblock">
                  <div class="content">
                  <pre>// nothing new here, plain old Event is used&#x000A;@Inject Event&lt;Payload&gt; event;&#x000A;&#x000A;public void sendAsyncEvent() {&#x000A;    // we use a new fireAsync method for asynchronous events&#x000A;    CompletionStage&lt;Payload&gt; eventResult = event.fireAsync(new Payload()).thenAccept(...);&#x000A;}&#x000A;&#x000A;public void asyncObserver (@ObservesAsync Payload payload){ â€¦ }</pre>
                  </div>
                  </div>
                  <div class="paragraph">
                  <p>Few things to note here - first of all, the return value of <code>fireAsync</code> is <code>CompletionStage</code> allowing you to chain the work for when the event is done.
                  You can follow-up with more tasks, react on exceptional return value and so on.
                  Another noticeable detail is that observers which are to be notified have to have <code>@ObservesAsync</code> annotation.
                  As you might have guessed, an observer can be notified of either synchronous (<code>@Observes</code>) or asynchronous (<code>@ObservesAsync</code>) events but never both!</p>
                  </div>
                  <div class="paragraph">
                  <p>Apart from this very basic usage, async events allow you to specify <code>NotificationOptions</code> - an option allowing you to tweak the way notification works.
                  From CDI perspective, there is currently only one standardized option and that enables usage of custom executors which will be used for notifications.
                  But the API was designed in a generic way so that implementation can enrich it with its own options.
                  Weld currently offers two more options - timeout and parallel execution - both of which are well described in <a href="http://docs.jboss.org/weld/reference/3.0.0.Final/en-US/html/events.html#_notification_options" target="_blank" rel="noopener">Weld docs</a>.
                  And here is a snippet showing it in action:</p>
                  </div>
                  <div class="paragraph">
                  <p>[ source, java ]</p>
                  </div>
                  <div class="listingblock">
                  <div class="content">
                  <pre>public void sendAsyncEventWithOptions() {&#x000A;    // we use a secondary version of fireAsync method with NotificationOptions parameter&#x000A;    event.fireAsync(new Payload(), NotificationOptions.of("weld.async.notification.timeout", 2000));&#x000A;}</pre>
                  </div>
                  </div>
                  </div>
                  </div>
                  <div class="sect1">
                  <h2 id="_configurators_api">Configurators API</h2>
                  <div class="sectionbody">
                  <div class="paragraph">
                  <p>Another of the key features are <a href="http://docs.jboss.org/cdi/spec/2.0/cdi-spec.html#configurators" target="blank"><code>Configurators</code></a>.
                  They are here to ease our work when doing small tweaks in extensions.
                  Here is a snippet showing how easy it can be to register a new bean in <code>AfterBeanDiscovery</code> using configurator.
                  You don&#8217;t have to create a new class implementing <code>Bean&lt;X&gt;</code> anymore:</p>
                  </div>
                  <div class="paragraph">
                  <p>[ source, java ]</p>
                  </div>
                  <div class="listingblock">
                  <div class="content">
                  <pre>public void addABean(@Observes AfterBeanDiscovery event) {&#x000A;    // get an instance of BeanConfigurator&#x000A;    event.addBean()&#x000A;      // set the desired data&#x000A;      .types(Foo.class)&#x000A;      .scope(RequestScoped.class)&#x000A;      .addQualifier(Custom.CustomLiteral.INSTANCE);&#x000A;      //finally, add a callback to tell CDI how to instantiate this bean&#x000A;      .produceWith(obj -&gt; new Foo());&#x000A;}</pre>
                  </div>
                  </div>
                  <div class="paragraph">
                  <p>Following configurators were added:</p>
                  </div>
                  <div class="ulist">
                  <ul>
                  <li>
                  <p><code>AnnotatedTypeConfigurator</code></p>
                  </li>
                  <li>
                  <p><code>InjectionPointConfigurator</code></p>
                  </li>
                  <li>
                  <p><code>BeanAttributesConfigurator</code></p>
                  </li>
                  <li>
                  <p><code>BeanConfigurator</code></p>
                  </li>
                  <li>
                  <p><code>ObserverMethodConfigurator</code></p>
                  </li>
                  <li>
                  <p><code>ProducerConfigurator</code></p>
                  </li>
                  </ul>
                  </div>
                  <div class="paragraph">
                  <p>On top of that, Weld adds one additional configurator - <a href="http://docs.jboss.org/weld/reference/latest/en-US/html_single/#_weld_enriched_container_lifecycle_events" target="_blank" rel="noopener"><code>InterceptorConfigurator</code></a>.
                  This one allows you to observe <code>WeldAfterBeanDiscovery</code> and then use this configurator to create and register a custom interceptor from scratch.</p>
                  </div>
                  </div>
                  </div>
                  <div class="sect1">
                  <h2 id="_se_bootstrap_api">SE Bootstrap API</h2>
                  <div class="sectionbody">
                  <div class="paragraph">
                  <p>A big change in CDI 2.0 is the SE support.
                  Of course, Weld fans have had this for years now, but it has gone official, so that still counts, right?</p>
                  </div>
                  <div class="paragraph">
                  <p>The official CDI API is very similar to that of Weld, here is how it looks like:</p>
                  </div>
                  <div class="paragraph">
                  <p>[ source, java ]</p>
                  </div>
                  <div class="listingblock">
                  <div class="content">
                  <pre>public void bootBasicContainer() {&#x000A;    SeContainerInitializer initializer = SeContainerInitializer.newInstance();&#x000A;    try (SeContainer container = initializer.initialize()) {&#x000A;        Assert.assertTrue(container.isRunning());&#x000A;    }&#x000A;}</pre>
                  </div>
                  </div>
                  <div class="paragraph">
                  <p>This is the very basic way; you can also opt to use synthetic bean archive where you cherry-pick all the beans/interceptors/&#8230;&#8203; in your archive.
                  <a href="http://docs.jboss.org/cdi/spec/2.0/cdi-spec.html#se_bootstrap" target="_blank" rel="noopener">CDI spec</a> describes this fairly well, so how about we instead shift our attention to what Weld SE offers on top of that?</p>
                  </div>
                  <div class="paragraph">
                  <p>A small reminder of how to boot SE container using pure Weld API:</p>
                  </div>
                  <div class="paragraph">
                  <p>[ source, java ]</p>
                  </div>
                  <div class="listingblock">
                  <div class="content">
                  <pre>public void bootWeldSeContainer() {&#x000A;    Weld weld = new Weld();&#x000A;    try (WeldContainer container = weld.initialize()) {&#x000A;        container.select(FooBean.class).get();&#x000A;    }&#x000A;}</pre>
                  </div>
                  </div>
                  <div class="paragraph">
                  <p>One of the things Weld makes easier, is when you want to create a quick extension, but don&#8217;t really want to write a whole new class which you then need to place in <code>META-INF/services</code> or register on bootstrap.
                  You can easily create a 'synthetic extension' programatically:</p>
                  </div>
                  <div class="paragraph">
                  <p>[ source, java ]</p>
                  </div>
                  <div class="listingblock">
                  <div class="content">
                  <pre>Extension testExtension = ContainerLifecycleObserver.extensionBuilder()&#x000A;    .add(afterBeanDiscovery((e) -&gt; System.out.println("Bean discovery completed!")))&#x000A;    .add(processAnnotatedType().notify((e) -&gt; {&#x000A;            if (e.getAnnotatedType().getJavaClass().getName().startsWith("com.foo")) {&#x000A;                e.veto();&#x000A;            }&#x000A;        })).build();&#x000A;&#x000A;try (WeldContainer container = new Weld().addExtension(testExtension).initialize()) {&#x000A;    // Use the container...&#x000A;}</pre>
                  </div>
                  </div>
                  <div class="paragraph">
                  <p>What we just did was to create an extension with two container lifecycle observer methods.
                  It follows a familiar builder pattern and the body of the observer methods is specified as lambda expression.
                  Before booting SE container, we register this extension as we would any other.
                  For more information about this, don&#8217;t hesitate to check our older <a href="http://weld.cdi-spec.org/news/2016/02/08/weld-se-synth-lifecycle-events/">news post</a>.</p>
                  </div>
                  </div>
                  </div>
                  <div class="sect1">
                  <h2 id="_on_demand_request_context_activation">On-demand Request Context Activation</h2>
                  <div class="sectionbody">
                  <div class="paragraph">
                  <p>Especially in SE (although not only there) you might want to activate a <code>RequestContext</code> manually for certain period of time.
                  There are two ways to achieve that, first of which is an interceptor - <code>@ActivateRequestContext</code>.
                  You can use that on either a method or a type (enabling it for all methods).
                  As you might expect, it will activate the context before executing your method and shut it down afterwards.
                  The other way is through means of built-in bean named <code>RequestContextController</code>.
                  This bean can be injected as any other CDI bean and offers to self-explanatory methods: <code>activate</code> and <code>deactivate</code>.
                  The obvious advantage of this approach is that you can enable the context for an extended period of time.</p>
                  </div>
                  </div>
                  </div>
                  <div class="sect1">
                  <h2 id="_observer_method_ordering">Observer Method Ordering</h2>
                  <div class="sectionbody">
                  <div class="paragraph">
                  <p>A small but noteworthy improvement to observer methods.
                  You can not leverage <code>@Priority</code> annotation in observer methods hence ordering them as you wish.</p>
                  </div>
                  <div class="paragraph">
                  <p>[ source, java ]</p>
                  </div>
                  <div class="listingblock">
                  <div class="content">
                  <pre>public void observeFirst (@Observes @Priority(1) EventPayload payload) {...}&#x000A;&#x000A;public void observeSecond (@Observes @Priority(2) EventPayload payload) {...}</pre>
                  </div>
                  </div>
                  </div>
                  </div>
                  <div class="sect1">
                  <h2 id="_intercepting_produced_beans">Intercepting Produced Beans</h2>
                  <div class="sectionbody">
                  <div class="paragraph">
                  <p>Up until now, anything you created using producers could not be easily intercepted.
                  CDI 2.0 allows this for <code>@AroundInvoke</code> interceptors in two ways.
                  There is a new method on <code>BeanManager</code> named <code>createInterceptionFactory</code> but most of the time you will rather use a built-in bean <code>InterceptionFactory</code> which can be injected as a producer method parameter.
                  Here is a snippet:</p>
                  </div>
                  <div class="paragraph">
                  <p>[ source, java ]</p>
                  </div>
                  <div class="listingblock">
                  <div class="content">
                  <pre>@Produces&#x000A;@Dependent&#x000A;public ProducedBean produceFoo(InterceptionFactory&lt;ProducedBean&gt; factory) {&#x000A;    factory.configure().add(Counter.Literal.INSTANCE);&#x000A;    return factory.createInterceptedInstance(new ProducedBean());&#x000A;}</pre>
                  </div>
                  </div>
                  <div class="paragraph">
                  <p>To explain this a bit, we first inject the built-in bean with the type equal to the produced type we wish to intercept.
                  Then we <code>configure()</code> it, which returns an <code>AnnotatedTypeConfigurator</code> allowing us to add interceptor binding.
                  Finally, we invoke <code>InterceptionFactory.createInterceptedInstance()</code> which takes a the object we produce as a parameter.</p>
                  </div>
                  <div class="paragraph">
                  <p>You can read more about this in <a href="http://docs.jboss.org/cdi/spec/2.0/cdi-spec.html#interception_factory" target="_blank" rel="noopener">this CDI spec chapter</a>.</p>
                  </div>
                  </div>
                  </div>
                  <div class="sect1">
                  <h2 id="_trimmed_bean_archives">Trimmed Bean Archives</h2>
                  <div class="sectionbody">
                  <div class="paragraph">
                  <p>Last but not least feature we will mention are so called 'trimmed' bean archives.
                  You can mark an explicit bean archive as trimmed in <code>beans.xml</code> by adding the <code>&lt;/trim&gt;</code> element.
                  Such bean archive will perform an annotated type discovery as with <code>bean-discovery-mode="all"</code> but all types that don&#8217;t have a bean defining annotation or any scope annotation are then removed from the set of discovered types.</p>
                  </div>
                  <div class="paragraph">
                  <p>Even in this case, Weld allows you to go one step further and <a href="http://docs.jboss.org/weld/reference/latest/en-US/html/configure.html#veto-types-without-bean-defining-annotation">veto types based on regular expression</a>.
                  It works on a similar principle but affects your whole application - it processess all types from all bean archives.
                  Your archives will be scanned as they would be with bean discovery mode <code>all</code> and <code>ProcessAnnotatedType</code> will be fired for all found annotated types.
                  Then, based on the regular expression you provide, annotated types which do not have a bean defining annotation and match the regular expression will be vetoed.</p>
                  </div>
                  </div>
                  </div>
                </div>
                
                            <div id="disqus_thread"></div>
                            <script type="text/javascript">
                            var disqus_shortname = 'weld-cdi';
                            var disqus_url = "https://weld.cdi-spec.org/news/2017/05/19/tour-around-weld-3/";
                            var disqus_developer = null;
                            var disqus_identifier = "6f90db2a11f00aaf474864da3242544ba4d2e41d";
                            (function() {
                              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
                              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
                            })();
                            </script>
                            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=weld-cdi">comments powered by Disqus.</a></noscript>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer>
      <div class="row">
        <div class="container" id="companyfooter">
          <div class="redhatlogo" style="text-align:center;">
            <div class="logospacer" style="height:10px;"></div>
            <a href="http://www.redhat.com/">
              <img src="http://static.jboss.org/theme/images/common/redhat_logo.png">
            </a>
          </div>
        </div>
      </div>
    </footer>
  </body>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" type="text/javascript"></script>
  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount','UA-45187401-1']);
  _gaq.push(['_trackPageview']);
  (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  </script>
  <script>
    $(document).ready(function() {
      $('#toggle_menu').click(function(){
        $("#mobile_menu").toggle();
      });
    });
  </script>
</html>
