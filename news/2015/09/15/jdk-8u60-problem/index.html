<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>
      Weld: JDK 8u60 reveals a problem in Weld
    </title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta name="description">
    <link href="/images/weld_icon_32x.ico" rel="shortcut icon" type="image/x-icon">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//static.jboss.org/css/tabzilla.css" media="screen" rel="stylesheet" type="text/css">
    <link href="http://weld.cdi-spec.org/stylesheets/styles.css" rel="stylesheet" type="text/css">
    <script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="//static.jboss.org/js/_jbossorg-tabzilla.js" type="text/javascript"></script>
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
    <link href="http://weld.cdi-spec.org/news.atom" rel="alternate" type="application/atom+xml">
    <link href="//cdn.jsdelivr.net/highlight.js/8.9.1/styles/hybrid.min.css" rel="stylesheet">
    <script src="//cdn.jsdelivr.net/highlight.js/8.9.1/highlight.min.js" type="text/javascript"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-2 col-sm-3">
          <div class="sidebar-nav">
            <div class="navbar navbar-default" role="navigation">
              <div class="navbar-header">
                <button ="button" class="navbar-toggle" data-target=".sidebar-navbar-collapse" data-toggle="collapse">
                  <span class="sr-only">
                    Toggle navigation
                  </span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a ="#" class="visible-xs navbar-brand">
                  <img alt="Weld Logo" src="/images/weld_logo_100x.png">
                </a>
              </div>
              <div class="collapse navbar-collapse sidebar-navbar-collapse">
                <ul class="nav navbar-nav">
                  <li>
                    <a href="/">
                      <i class="fa fa-home"></i>
                      &nbsp;Home
                    </a>
                  </li>
                  <li>
                    <a href="/download">
                      <i class="fa fa-download"></i>
                      &nbsp;Download
                    </a>
                  </li>
                  <li>
                    <a href="/news">
                      <i class="fa fa-newspaper-o"></i>
                      &nbsp;News
                    </a>
                  </li>
                  <li>
                    <a href="https://issues.jboss.org/projects/WELD?selectedItem=com.atlassian.jira.jira-projects-plugin:release-page" target="_blank">
                      <i class="fa fa-road"></i>
                      &nbsp;Road Map
                    </a>
                  </li>
                  <li>
                    <a href="/documentation">
                      <i class="fa fa-book"></i>
                      &nbsp;Docs &amp; FAQ
                    </a>
                  </li>
                  <li>
                    <a href="/news/tags/tips">
                      <i class="fa fa-lightbulb-o"></i>
                      &nbsp;Tips and Tricks
                    </a>
                  </li>
                  <li>
                    <a href="/community">
                      <i class="fa fa-group"></i>
                      &nbsp;Community
                    </a>
                  </li>
                  <li>
                    <a href="http://github.com/weld" target="_blank">
                      <i class="fa fa-github-alt"></i>
                      &nbsp;Source Code
                    </a>
                  </li>
                  <li>
                    <a href="https://issues.jboss.org/browse/WELD#selectedTab=com.atlassian.jira.plugin.system.project%3Asummary-panel" target="_blank">
                      <i class="fa fa-tasks"></i>
                      &nbsp;Bug Tracker
                    </a>
                  </li>
                  <li>
                    <a href="https://twitter.com/jbossweld" target="_blank">
                      <i class="fa fa-twitter"></i>
                      &nbsp;Follow @jbossweld
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-10 col-sm-9">
          <div class="row hidden-xs">
            <div class="dropup">
              <div id="ajbossproject">
                A JBoss Project
              </div>
              <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
              <script>
                window.addEventListener('load', function() {renderTabzilla("Weld", "weld", false )}, false);
              </script>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <a href="/">
                <img alt="Weld Logo" class="hidden-xs weld-home-logo" src="/images/weld_logo_450x.png">
              </a>
            </div>
            <div class="col-md-8">
              <img alt="CDI tagcloud" class="hidden-xs hidden-sm cdi-background" src="/images/CDIbackground.png">
            </div>
          </div>
          <div class="row content-wrapper">
            <div class="col-md-12">
              <div class="post">
                <h1>
                  JDK 8u60 reveals a problem in Weld
                  <a href="http://weld.cdi-spec.org/news.atom" title="Subscribe to Weld news">
                    <i class="fa fa-rss"></i>
                  </a>
                </h1>
                <div class="news-date news-boxed">
                  2015-9-15
                  &nbsp;
                  <span class="tags">
                    <i class="fa fa-tags"></i>
                    <a href="/news/tags/bug">bug</a>
                    ,
                    <a href="/news/tags/jdk">jdk</a>
                  </span>
                  &nbsp;
                  <i class="fa fa-pencil"></i>
                  Martin Kouba
                </div>
                <p></p>
                <div class="content">
                  <div class="paragraph">
                  <p>Recently released <strong>JDK 8u60</strong> has revealed a problem in Weld where not all synthetic members were ignored correctly.
                  This has been fixed in <strong>2.2.16.Final</strong>, <strong>2.3.0.CR2</strong> and <strong>3.0.0.Alpha14</strong> (not released yet).
                  However, if not using a lambda referencing an event/disposed parameter inside an observer/disposer method, your application is most probably not affected.
                  See also <a href="https://issues.jboss.org/browse/WELD-2019">the related issue - WELD-2019</a>.</p>
                  </div>
                  <div class="sect1">
                  <h2 id="_use_case">Use case</h2>
                  <div class="sectionbody">
                  <div class="paragraph">
                  <p>If there is a lambda referencing an event/disposed parameter inside an observer/disposer method, the compiler creates a synthetic method with the event parameter as one of the method parameters. Since 8u60 the parameter annotations are preserved even for the synthetic method.
                  And so Weld incorrectly recognizes these synthetic methods as observer/disposer methods.</p>
                  </div>
                  </div>
                  </div>
                  <div class="sect1">
                  <h2 id="_symptoms">Symptoms</h2>
                  <div class="sectionbody">
                  <div class="paragraph">
                  <p>You may get <code>WELD-000409: Observer method for container lifecycle event can only&#8230;&#8203;</code> if using such a lambda in an extension or even <code>WELD-001408 Unsatisfied dependencies for type&#8230;&#8203;</code> if using such a lambda in a regular observer and the lambda is using more references (i.e. not only event/disposed parameter) - these are also the method parameters of the synthetic method, and in CDI these additional parameters are injection points.</p>
                  </div>
                  </div>
                  </div>
                  <div class="sect1">
                  <h2 id="_example">Example</h2>
                  <div class="sectionbody">
                  <div class="listingblock">
                  <div class="content">
                  <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Foo {&#x000A;  void observe(@Observes @Juicy String payload) {&#x000A;    Arrays.asList("foo").stream().filter((s) -&gt; s.equals(payload));&#x000A;  }&#x000A;}</code></pre>
                  </div>
                  </div>
                  <div class="paragraph">
                  <p>A synthetic method is created for the lambda and the event parameter is passed as a method parameter. The annotations are preserved.
                  As a result Weld creates two observer methods having the same event parameter: <code>@Observes @Juicy String payload</code>.</p>
                  </div>
                  </div>
                  </div>
                  <div class="sect1">
                  <h2 id="_workaround">Workaround</h2>
                  <div class="sectionbody">
                  <div class="paragraph">
                  <p>Instead of the event parameter reference use an additional local variable with the same value assigned:</p>
                  </div>
                  <div class="listingblock">
                  <div class="content">
                  <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void observe(@Observes @Juicy String payload) {&#x000A;   String p = payload;&#x000A;   Arrays.asList("foo").stream().filter((s) -&gt; s.equals(p));&#x000A;}</code></pre>
                  </div>
                  </div>
                  </div>
                  </div>
                </div>
                
                            <div id="disqus_thread"></div>
                            <script type="text/javascript">
                            var disqus_shortname = 'weld-cdi';
                            var disqus_url = "http://weld.cdi-spec.org/news/2015/09/15/jdk-8u60-problem/";
                            var disqus_developer = null;
                            var disqus_identifier = "1f9323e6c05b5e57eff0671cba32081abd4b79f9";
                            (function() {
                              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
                              dsq.src = "http://weld-cdi.disqus.com/embed.js";
                              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
                            })();
                            </script>
                            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=weld-cdi">comments powered by Disqus.</a></noscript>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer>
      <div class="row">
        <div class="container" id="companyfooter">
          <div class="redhatlogo" style="text-align:center;">
            <div class="logospacer" style="height:10px;"></div>
            <a href="http://www.redhat.com/">
              <img src="http://static.jboss.org/theme/images/common/redhat_logo.png">
            </a>
          </div>
        </div>
      </div>
    </footer>
  </body>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" type="text/javascript"></script>
  <script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script>
  <script type="text/javascript">
  try {
  var pageTracker = _gat._getTracker("UA-45187401-1");
  pageTracker._trackPageview();
  } catch(err) {}</script>
  <script>
    $(document).ready(function() {
      $('#toggle_menu').click(function(){
        $("#mobile_menu").toggle();
      });
    });
  </script>
</html>
